version: "3.9"

services:
  vllm-app:
    build: .
    container_name: vllm-app
    working_dir: /app
    ports:
      - "8501:8501"

    # Keep secrets out of the file; use a local .env
    env_file:
      - .env

    environment:
      # Core app config (non-secrets)
      PIPER_BIN: /usr/local/bin/piper
      PIPER_VOICE: /opt/piper/voices/en_US-amy-medium.onnx
      WAV2LIP_CHECKPOINT: /models/wav2lip/wav2lip_gan.pth
      ORT_LOG_SEVERITY_LEVEL: "3"
      STREAMLIT_SERVER_HEADLESS: "true"
      STREAMLIT_SERVER_ADDRESS: "0.0.0.0"
      STREAMLIT_BROWSER_GATHERUSAGESTATS: "false"
      STREAMLIT_SERVER_FILEWATCHER_TYPE: "none"
      SADTALKER_POSE_SCALE: "1.2"
      SADTALKER_EXPRESSION_SCALE: "1.3"
      SADTALKER_STILL_MODE: "false"
      SADTALKER_PREPROCESS: "full"
      SADTALKER_ENHANCER: "gfpgan"
      SADTALKER_TIMEOUT: "300"
      FAL_TIMEOUT: "1800"
      FAL_REQ_TIMEOUT: "45"
      FAL_POLL_EVERY: "2.0"
      FAL_RESPONSE_GRACE: "60"
      FAL_CONC_BACKOFF_S: "5"
      FAL_CONC_BACKOFF_MAX: "60"
      FAL_MAX_SUBMIT_RETRIES: "40"
      INFINITALK_URL: http://infinitetalk:8000
      INFINITALK_API_KEY: dev-key

    volumes:
      - ./app:/app/app
      - ./models:/models
      - ./voices:/opt/piper/voices
      - ./outputs:/app/outputs

    # Faster /tmp and cleans on container restart
    tmpfs:
      - /tmp:exec,mode=1777

    # App readiness probe (Streamlit exposes /_stcore/health)
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O- http://localhost:8501/_stcore/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
      start_period: 30s

    # Cap container logs
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

    # Auto-restart on failure
    restart: unless-stopped
    depends_on:
      - infinitetalk


  infinitetalk:
    build:
      context: ./services/infinitetalk
    environment:
      - INFINITALK_API_KEY=dev-key
    ports:
      - "8000:8000"
    gpus: all
    restart: unless-stopped